# AGENTS.md

## リポジトリ概要

これは、Nix flakes を使用したホームサーバーインフラ用の NixOS 設定リポジトリです。このリポジトリは、モジュラーで宣言的なアプローチを使用してサーバーホストのシステム設定を管理します。

## アーキテクチャ

- **flake.nix**: システム設定と依存関係を定義するメインエントリーポイント
- **hosts/**: ホスト名で整理されたホスト固有の設定
- **docs/**: システムドキュメントとセットアップガイド

この flake は `nixosConfigurations` 属性セットを定義し、各ホスト設定は `hosts/` ディレクトリ内のそれぞれの設定ファイルを指します。

## 一般的なコマンド

```bash
# システム設定をビルド
nix build .#nixosConfigurations.carbon.config.system.build.toplevel

# 設定をテスト（ドライラン）
nixos-rebuild dry-build --flake .#carbon

# 現在のシステムに設定を適用（ターゲットホストで実行する場合）
sudo nixos-rebuild switch --flake .#carbon

# リモートホストにビルドしてデプロイ
nixos-rebuild switch --flake .#carbon --target-host carbon

# flake の入力を更新
nix flake update

# flake の構文と評価をチェック
nix flake check

# flake の出力を表示
nix flake show

# 必要なツールを含む開発シェルに入る
nix develop

# Nix ファイルをフォーマット
nix fmt
```

## 設定構造

各ホスト設定は標準の NixOS モジュールシステムから継承されます。`meta` specialArgs は設定ファイルでアクセス可能なホスト固有のメタデータを提供します。

### ディレクトリ構造

```
hosts/
├── carbon/
│   ├── configuration.nix      # メインホスト設定
│   ├── hardware-configuration.nix  # ハードウェア固有の設定
│   └── services/
│       ├── default.nix        # サービスモジュールのインポート
│       └── minecraft.nix      # Minecraft サービス設定
```

### サービス管理

サービスは各ホストの `services/` ディレクトリ内のモジュラーファイルで整理されます。各サービスモジュールは `services/default.nix` ファイルを通じてインポートされ、関心事の明確な分離を維持します。

## コーディング規則

- 各ファイルは可能な限り小さく保つこと。 20~50 行が理想。 **決して 100 行は超えないようにする**。
- ディレクトリは適切に分割する。各ディレクトリ 2~10 ファイルが理想。
- **決して**同じことをするコードを重複させてはいけません。
  - 呼び出しスタックの各層は重複してはいけない。
  - 似たようなことをするコードはこれに該当しない。
- 使わなくなったコードは、 **必ず**消す。
- コードの削除に躊躇は必要ない。すべてのコードは保持するのにコストがかかることを忘れてはいけない。

## ドキュメント規則

- `docs/` にドキュメントを配置する。
- 作業前に関連するドキュメントを探す。
- ドキュメントに残す内容は、何をしたかではなく、システムがどう動くかを残す。
- 作業後は、**必ず**作業によって生じた変化をドキュメントに反映する。これを怠ってはならない。

## 注意事項

- nix flake がファイルを認識するには、git でステージングする必要があります: `git add -A -N`

## 問題解決の原則

- **ドキュメントファースト**: 推測ではなく、まずは公式ドキュメントや設定例を参照する
- **最小限の変更**: 複雑な解決策より、シンプルな変更から試す
- **段階的確認**: 小さな変更を重ねて、問題を特定する
- **既存情報の尊重**: ユーザーが提供した情報を軽視しない
- **検証の重要性**: 実際の動作や設定を確認してから回答する
- **最小コードの原則**: コードは短ければ短いほうがいい。長いコードは悪いコードだ。
